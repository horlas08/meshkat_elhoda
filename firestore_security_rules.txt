// Firestore Security Rules for Quran App Bookmarks
// Copy these rules to your Firebase Console -> Firestore Database -> Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to validate bookmark data
    function isValidBookmark() {
      let data = request.resource.data;
      return data.keys().hasAll(['surahNumber', 'surahName', 'ayahNumber', 'ayahText', 'createdAt'])
        && data.surahNumber is int
        && data.surahNumber >= 1
        && data.surahNumber <= 114
        && data.surahName is string
        && data.surahName.size() > 0
        && data.ayahNumber is int
        && data.ayahNumber >= 1
        && data.ayahText is string
        && data.ayahText.size() > 0
        && data.createdAt is timestamp
        && (!data.keys().hasAny(['note']) || data.note is string);
    }
    
    // Users collection
    match /users/{userId} {
      // Allow users to read their own user document
      allow read: if isOwner(userId);
      
      // Bookmarks subcollection
      match /bookmarks/{bookmarkId} {
        // Allow users to read their own bookmarks
        allow read: if isOwner(userId);
        
        // Allow users to create bookmarks with valid data
        allow create: if isOwner(userId) && isValidBookmark();
        
        // Allow users to update their own bookmarks
        allow update: if isOwner(userId) && isValidBookmark();
        
        // Allow users to delete their own bookmarks
        allow delete: if isOwner(userId);
      }
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
