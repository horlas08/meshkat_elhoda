# ๐ง ุชุตุญูุญุงุช Audio Player - ุญู ุงููุดุงูู ุงูุฃุณุงุณูุฉ

## ๐ ุงููุดุงูู ุงูุชู ุชู ุญูููุง

### โ ุงููุดููุฉ 1: ุงูุชุดุบูู ุงูุชููุงุฆู ุนูุฏ ูุชุญ ุงูุณูุฑูู
**ุงูุฎุทุฃ ุงูุฃุตูู:**
- ุงูุณูุฑุฉ ุชุจุฏุฃ ุจุงูุชุดุบูู ุชููุงุฆูุงู ุนูุฏ ูุชุญ ุณูุฑูู ุงููุดุบู
- ูุง ููุฌุฏ ุฎูุงุฑ ูููุณุชุฎุฏู ููุจุฏุฃ ุงูุชุดุบูู ุจููุณู

**ุงูุญู ุงููุทุจู:**
```dart
// ุงูุญุฐู:
WidgetsBinding.instance.addPostFrameCallback((_) {
  _initializeAudio();  // โ ุชุดุบูู ุชููุงุฆู
});

// ุงูุฅุถุงูุฉ:
// ูุง ูุดุบู ุงูุตูุช ุชููุงุฆูุงู - ููุชุธุฑ ุฃู ูุถุบุท ุงููุณุชุฎุฏู ุนูู ุฒุฑ ุงูุชุดุบูู
_isInitialized = true;
```

**ุงููุชูุฌุฉ:**
- โ ุงูุณูุฑูู ุชุธูุฑ ุฏูู ุชุดุบูู ุตูุช
- โ ุงููุณุชุฎุฏู ูุชุญูู ุจุฒุฑ ุงูุชุดุบูู
- โ ููุน ุงูุฃุฎุทุงุก ุงููุชุนููุฉ ุจุงูุชุญููู ุงููุชุฒุงูู

---

### โ ุงููุดููุฉ 2: ุงูุดุฑูุท (Slider) ูุง ูุชุญุฑู ูุน ุงูุตูุช
**ุงูุฎุทุฃ ุงูุฃุตูู:**
```
Loading interrupted
```
- ุงูุดุฑูุท ูุง ูุญุฏูุซ ููุถุนู ุฃุซูุงุก ุงูุชุดุบูู
- ุงูู position ูุง ูุชุบูุฑ ูู ุงูุญุงูุฉ

**ุงูุญู ุงููุทุจู:**

#### ุฃ) ุฅุตูุงุญ ุญุณุงุจ ููู ุงูู Slider:
```dart
// ุงูุญุณุงุจ ุงูุฌุฏูุฏ ุงูุตุญูุญ:
final maxDuration = playerState.duration.inSeconds.toDouble();
final maxValue = maxDuration > 0 ? maxDuration : 1.0;  // ุชุฌูุจ ุงูุตูุฑ
final currentPosition = playerState.position.inSeconds.toDouble();
final sliderValue = currentPosition.clamp(0, maxValue);  // ุถูุงู ุงูููู ุงูุตุญูุญุฉ

Slider(
  value: sliderValue,  // ุงููููุฉ ุงููุนููุฉ
  max: maxValue,       // ุงูุญุฏ ุงูุฃูุตู ุงูุตุญูุญ
)
```

#### ุจ) ุฅุถุงูุฉ ุขููุฉ ุงูุจุซ ุงููุณุชูุฑ (Continuous Stream Listener):
```dart
// ูู QuranAudioBloc constructor:
void _setupPositionListener() {
  audioPlayerService.positionStream.listen((position) {
    if (state is AudioPlayerPlaying) {
      final currentState = state as AudioPlayerPlaying;
      // ุชุญุฏูุซ ุงูุญุงูุฉ ุจุงูููุถุน ุงูุฌุฏูุฏ ูู ูุฑุฉ
      emit(
        AudioPlayerPlaying(
          track: currentState.track,
          position: position,  // โ ุชุญุฏูุซ ุงูููุถุน
          duration: currentState.duration,
        ),
      );
    }
  });
}
```

**ุงููุชูุฌุฉ:**
- โ ุงูุดุฑูุท ูุชุญุฑู ุจุณูุงุณุฉ ูุน ุงูุตูุช
- โ ุงูููุช ุงูุญุงูู ูุชุญุฏุซ ุจุดูู ููุฑู
- โ ุชุญุฏูุซ UI ูู ุงูููุช ุงููุนูู

---

### โ ุงููุดููุฉ 3: ุฃุฎุทุงุก ุงูุชุญููู (Loading Interrupted)
**ุงูุฎุทุฃ ุงูุฃุตูู:**
```
โ Error loading ayah: Loading interrupted
โ Error playing track: Loading interrupted
```

**ุงูุญู ุงููุทุจู:**

#### ุฃ) ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ุฃูุถู:
```dart
Future<void> playTrack(AudioTrack track, {int retryCount = 0}) async {
  try {
    // ุชููู ุงูุตูุช ุงูุณุงุจู ุฃููุงู
    if (_audioPlayer.playing) {
      await _audioPlayer.stop();
    }

    // ุชุญููู ุงููุณุงุฑ ูุน timeout
    try {
      await _audioPlayer.setUrl(track.audioUrl).timeout(
        const Duration(seconds: 30),
        onTimeout: () => throw Exception('Audio URL loading timeout'),
      );
    } catch (e) {
      // ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุฑุฉ ูุงุญุฏุฉ
      if (retryCount < 1) {
        await Future.delayed(const Duration(seconds: 1));
        return playTrack(track, retryCount: retryCount + 1);
      }
      rethrow;
    }

    // ุชุญุฏูุซ ุงูุฎุฏูุฉ ุงูุฎูููุฉ (non-blocking)
    try {
      await _quranAudioService.loadAyah(...);
    } catch (e) {
      log('โ๏ธ Background service error (non-blocking): $e');
      // ูุง ูุชููู - ูุณุชูุฑ ูู ุงูุชุดุบูู
    }

    // ุงูุชุดุบูู
    await _audioPlayer.play();
  } catch (e) {
    log('โ Error playing track: $e');
    rethrow;
  }
}
```

#### ุจ) ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงูุชุดุบูู ุงููุชูุฏูุฉ:
```dart
// ูู resume():
Future<void> resume() async {
  try {
    await _audioPlayer.play();
    try {
      await _quranAudioService.play();  // ูุฏ ุชูุดู - ูุง ูุชููู
    } catch (e) {
      log('โ๏ธ Error resuming background service: $e');
    }
  } catch (e) {
    log('โ Error resuming: $e');
    rethrow;
  }
}
```

**ุงููุชูุฌุฉ:**
- โ ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก
- โ ุฅุนุงุฏุฉ ูุญุงููุฉ ุชููุงุฆูุฉ
- โ ุงุณุชูุฑุงุฑ ุงูุชุดุบูู ุญุชู ูู ูุดู ุงูุชุทุจูู ุงูุฎููู

---

## ๐ฎ ุงูุชุญูู ุงูุขู:

| ุงูุญุฏุซ | ุงูุขููุฉ |
|------|-------|
| **ูุชุญ ุงูุณูุฑูู** | ุชุธูุฑ ุจุฏูู ุชุดุบูู ุตูุช (ููููู ุงูุจุฏุก ูู ุงูุฑุงุญุฉ) |
| **ุงุถุบุท ุงูุชุดุบูู** | ูุจุฏุฃ ุงูุตูุช ูู ุงูุจุฏุงูุฉ |
| **ุงูุณุญุจ ุนูู ุงูุดุฑูุท** | ูุฐูุจ ุงูุตูุช ุฅูู ุงูููุถุน ุงููุทููุจ |
| **ุงูุฅููุงู ุงููุคูุช** | ูุชููู ุงูุตูุช ูุน ุงูุญูุธ ุงูููุถุน |
| **ุงูุงุณุชุฆูุงู** | ูุณุชุฃูู ูู ุงูููุถุน ุงูุณุงุจู |
| **ุงูุชุงูู** | ููุชูู ููุณูุฑุฉ ุงูุชุงููุฉ |
| **ุงูุณุงุจู** | ูุนูุฏ ููุณูุฑุฉ ุงูุณุงุจูุฉ |
| **ุงูุฅููุงู ุงููุงูู** | ูููู ุงูุตูุช ููุนูุฏ ููุจุฏุงูุฉ |

---

## ๐ ุขููุฉ ุงูุจุซ (Stream Architecture)

```
AudioPlayerService.positionStream
        โ
   emit() ูู ุงูู position
        โ
   _setupPositionListener() ูู BLoC
        โ
   emit AudioPlayerPlaying/Paused ูุน position ุฌุฏูุฏ
        โ
   BlocBuilder ูุนูุฏ ุจูุงุก ุงูู UI
        โ
   Slider ูุชุญุฏุซ ูุน ุงูููุถุน ุงูุฌุฏูุฏ
```

---

## ๐งช ุงุฎุชุจุฑ ุงูุขู:

1. **ุงุถุบุท ุนูู ุณูุฑุฉ** โ ุชุฐูุจ ููุณูุฑูู
2. **ุดุงูุฏ ุงูุดุฑูุท** โ ูุฌุจ ุฃู ูููู ูู ุงูุจุฏุงูุฉ (ุตูุฑ)
3. **ุงุถุบุท Play** โ ูุจุฏุฃ ุงูุตูุช
4. **ุฑุงูุจ ุงูุดุฑูุท** โ ูุฌุจ ุฃู ูุชุญุฑู ูุน ุงูุตูุช
5. **ุงุณุญุจ ุงูุดุฑูุท** โ ูุฌุจ ุฃู ูุฐูุจ ุงูุตูุช ููููุถุน ุงูุฌุฏูุฏ
6. **ุงุถุบุท Pause** โ ูุชููู ุงูุตูุช ูุงูุดุฑูุท
7. **ุงุถุบุท Play** โ ูุณุชุฃูู ูู ุงูููุถุน ุงูุณุงุจู

---

## ๐ฏ ุงูููุฎุต

| ุงููุดููุฉ | ุงูุญู | ุงููุชูุฌุฉ |
|--------|------|--------|
| ุชุดุบูู ุชููุงุฆู | ุฅุฒุงูุฉ ุงูู auto-play | โ ุชุญูู ูุฏูู |
| slider ุซุงุจุช | ุฅุถุงูุฉ stream listener | โ ุชุญุฏูุซ ููุฑู |
| ุฃุฎุทุงุก ูุชูุฑุฑุฉ | ูุนุงูุฌุฉ ุฃูุถู + retry | โ ุงุณุชูุฑุงุฑ ุฃูุถู |

---

## ๐ ุงููููุงุช ุงููุนุฏููุฉ

1. **audio_player_screen.dart**
   - ุฅุฒุงูุฉ ุงูุชุดุบูู ุงูุชููุงุฆู
   - ุชุญุณูู ุญุณุงุจ ููู ุงูู Slider

2. **audio_player_service.dart**
   - ุชุญุณูู ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงูุชุญููู
   - ุฅุถุงูุฉ retry mechanism
   - ูุนุงูุฌุฉ ุฃูุถู ููุฎุฏูุฉ ุงูุฎูููุฉ

3. **quran_audio_cubit.dart**
   - ุฅุถุงูุฉ `_setupPositionListener()`
   - ุชุญุฏูุซ ูุณุชูุฑ ููู position

---

**ุชู ุจูุฌุงุญ! ๐**
