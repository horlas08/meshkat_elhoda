# ุญู ูุดููุฉ "Loading interrupted" ูู ูุดุบู ุงูุตูุช

## ๐ด ุงููุดููุฉ ุงูุฃุตููุฉ

```
โ Error loading ayah: Loading interrupted
โ Error playing track: Loading interrupted
โ Error playing playlist: Loading interrupted
```

### ุงูุณุจุจ ุงูุฌุฐุฑู:
ุนูุฏูุง ูุญุงูู ุงูุชุทุจูู ุชุญููู ููู ุตูุชู ูู ุงูุฅูุชุฑูุช (mp3) ูู ุฎุงุฏู mp3quran.netุ ูุฏ ูุญุฏุซ ุงููุทุงุน ูู ุงูุงุชุตุงู ูุฃุณุจุงุจ ูุชุนุฏุฏุฉ:

1. **ุงููุทุงุน ุงูุฅูุชุฑูุช ุงููุคูุช** - ุนุฏู ุงุณุชูุฑุงุฑ ุงูุงุชุตุงู
2. **timeout ูู ุงูุฎุงุฏู** - ุงูุฎุงุฏู ูุณุชุบุฑู ููุชุงู ุทูููุงู ููุงุณุชุฌุงุจุฉ
3. **ุฎุทุฃ ูู ุชุญููู ุงูููู** - ุงูููู ูุฏ ูุง ูููู ูุชุงุญุงู
4. **ุชุถุงุฑุจ ูู ุงูุนูููุงุช** - ุนูููุงุช ูุชุนุฏุฏุฉ ุชุญุงูู ุงูุชุญููู ูู ููุณ ุงูููุช

---

## โ ุงูุญู ุงููุทุจู

### 1๏ธโฃ **ุฅุถุงูุฉ ุขููุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ (Retry Mechanism)**

**ููู**: `lib/core/services/audio_player/audio_player_service.dart`

```dart
// ุฅุถุงูุฉ ูุนุงูู retryCount
Future<void> playTrack(AudioTrack track, {int retryCount = 0}) async {
  // ...
  try {
    await _audioPlayer.setUrl(track.audioUrl).timeout(
      const Duration(seconds: 30),
      onTimeout: () => throw Exception('Audio URL loading timeout'),
    );
  } catch (audioError) {
    // ุฅุนุงุฏุฉ ูุญุงููุฉ ูุงุญุฏุฉ
    if (retryCount < 1) {
      log('๐ Retrying to play track...');
      await Future.delayed(const Duration(seconds: 1));
      return playTrack(track, retryCount: retryCount + 1);
    }
  }
}
```

โจ **ุงููุงุฆุฏุฉ**: ุฅุฐุง ูุดู ุงูุชุญููู ูุฑุฉุ ูุนุงุฏ ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ุชุฃุฎูุฑ ูุตูุฑ.

---

### 2๏ธโฃ **ูุนุงูุฌุฉ ุขููุฉ ูุฎุฏูุฉ ุงูุฎูููุฉ (Non-blocking Background Service)**

```dart
// ูู playTrack:
try {
  await _quranAudioService.loadAyah(...);
} catch (e) {
  log('โ๏ธ Background service error (non-blocking): $e');
  // ูุง ูููู ุงูุชุดุบูู - ุงูุฎุฏูุฉ ุงูุฎูููุฉ ุงุฎุชูุงุฑูุฉ
}

// ูู pause/resume/seek:
try {
  await _quranAudioService.pause();
} catch (e) {
  log('โ๏ธ Error pausing background service: $e');
  // ูุชุงุจุน ุงูุชุดุบูู ุงููุญูู ุญุชู ูู ูุดูุช ุงูุฎุฏูุฉ ุงูุฎูููุฉ
}
```

โจ **ุงููุงุฆุฏุฉ**: ูุดู ุงูุฎุฏูุฉ ุงูุฎูููุฉ ูุง ูููู ุงูุชุดุบูู ุงููุญูู.

---

### 3๏ธโฃ **ุฅุถุงูุฉ Timeout ููุงุณุจ (30 ุซุงููุฉ)**

```dart
await _audioPlayer.setUrl(track.audioUrl).timeout(
  const Duration(seconds: 30),
  onTimeout: () => throw Exception('Audio URL loading timeout'),
);
```

โจ **ุงููุงุฆุฏุฉ**: ุจุฏูุงู ูู ุงูุงูุชุธุงุฑ ุงููุงููุงุฆูุ ููุชุธุฑ 30 ุซุงููุฉ ุจุญุฏ ุฃูุตู.

---

### 4๏ธโฃ **ูุญุงููุฉ ูุชูุฏูุฉ ูู ุงูู Cubit**

**ููู**: `lib/features/quran_audio/presentation/bloc/quran_audio_cubit.dart`

```dart
Future<void> _onPlayPlaylist(
  PlayPlaylistEvent event,
  Emitter<QuranAudioState> emit,
) async {
  try {
    emit(AudioPlayerLoading());
    await audioPlayerService.playPlaylist(event.playlist, event.startIndex);
    emit(AudioPlayerPlaying(...));
  } catch (e) {
    log('โ Error playing playlist: $e');
    emit(AudioPlayerError(message: 'ุฌุงุฑู ุชุญููู ุงูุตูุช...'));
    
    // ูุญุงููุฉ ุซุงููุฉ ุจุนุฏ ุชุฃุฎูุฑ
    await Future.delayed(const Duration(seconds: 2));
    try {
      await audioPlayerService.playPlaylist(event.playlist, event.startIndex);
      emit(AudioPlayerPlaying(...));
      log('โถ๏ธ Retry successful');
    } catch (retryError) {
      emit(AudioPlayerError(message: 'ุฎุทุฃ ูู ุงูุชุดุบูู. ุชุฃูุฏ ูู ุงูุฅูุชุฑูุช'));
    }
  }
}
```

โจ **ุงููุงุฆุฏุฉ**: ูุญุงููุฉ ุซุงูุซุฉ ุนูู ูุณุชูู ุงูู UI ุจุนุฏ 2 ุซุงููุฉ.

---

## ๐ ุฑุณุงุฆู ุงูุณุฌู ุงูุฌุฏูุฏุฉ

### ุนูุฏ ุงููุฌุงุญ:
```
โณ Loading: ุณูุฑุฉ ุงููุงุชุญุฉ (attempt 1)
โถ๏ธ Playing: ุณูุฑุฉ ุงููุงุชุญุฉ - ูุญูุฏ ุงูุนุฑููู
```

### ุนูุฏ ุงููุดู ูุงูุฅุนุงุฏุฉ:
```
โณ Loading: ุณูุฑุฉ ุงููุงุชุญุฉ (attempt 1)
โ๏ธ Audio loading error: Loading interrupted
๐ Retrying to play track...
โณ Loading: ุณูุฑุฉ ุงููุงุชุญุฉ (attempt 2)
โถ๏ธ Playing: ุณูุฑุฉ ุงููุงุชุญุฉ - ูุญูุฏ ุงูุนุฑููู
```

### ุนูุฏ ูุดู ุงูุฎุฏูุฉ ุงูุฎูููุฉ ููุท:
```
โณ Loading: ุณูุฑุฉ ุงููุงุชุญุฉ (attempt 1)
โ๏ธ Background service error (non-blocking): Socket exception
โถ๏ธ Playing: ุณูุฑุฉ ุงููุงุชุญุฉ - ูุญูุฏ ุงูุนุฑููู
```

---

## ๐ ูุณุชููุงุช ุงูุญูุงูุฉ (Layers of Protection)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ     ุงููุณุชุฎุฏู (UI Layer)         โ
โ  โข ูุฑู ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุฌุฏุงู      โ
โ  โข ุงูุชุธุงุฑ ูุทูู ูุน spinner       โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ    Cubit (State Management)      โ
โ  โข ูุญุงููุฉ ุฃููู + ุงูุชุธุงุฑ         โ
โ  โข ูุญุงููุฉ ุซุงููุฉ ุจุนุฏ ุชุฃุฎูุฑ        โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  AudioPlayerService             โ
โ  โข ูุญุงููุฉ ุซุงูุซุฉ ูู playTrack   โ
โ  โข ูุนุงูุฌุฉ ุขููุฉ ููุฃุฎุทุงุก         โ
โ  โข ุนุฒู ุงูุฃุฎุทุงุก ุงูุฎูููุฉ         โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   just_audio (Low-Level)        โ
โ  โข ุชุญููู ุงููุณุงุฑ ุงููุนูู          โ
โ  โข timeout 30 ุซุงููุฉ            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ูุชุงุฆุฌ ุงูุญู

| ุงููุดููุฉ | ุงูุญู | ุงููุชูุฌุฉ |
|--------|------|--------|
| ุงููุทุงุน ุฃูู ูุฑุฉ | ูุญุงููุฉ ุซุงููุฉ ุชููุงุฆูุฉ | โ ูุนูู |
| ูุดู ุงูุฎุฏูุฉ ุงูุฎูููุฉ | ูุนุงูุฌุฉ ูููุตูุฉ | โ ุงูุชุดุบูู ูุณุชูุฑ |
| Timeout ุทููู | 30 ุซุงููุฉ ุจุญุฏ ุฃูุตู | โ ุงุณุชุฌุงุจุฉ ุณุฑูุนุฉ |
| ุฑุณุงูุฉ ุฎุทุฃ ุบุงูุถุฉ | ุฑุณุงุฆู ุนุฑุจูุฉ ูุงุถุญุฉ | โ ูุณุชุฎุฏู ุณุนูุฏ |

---

## ๐งช ููููุฉ ุงูุงุฎุชุจุงุฑ

### ุงูุงุฎุชุจุงุฑ 1: ุงูุงุชุตุงู ุงูุฌูุฏ
```
โ ูุชูุฌุฉ ูุชููุนุฉ: ุงูุชุดุบูู ููุฑู
```

### ุงูุงุฎุชุจุงุฑ 2: ูุทุน ุงูุฅูุชุฑูุช ุฃุซูุงุก ุงูุชุญููู
```
1. ุงุจุฏุฃ ุงูุชุดุบูู
2. ุฃููู ุงูุฅูุชุฑูุช ุจุณุฑุนุฉ
3. โ ุงูุชุทุจูู ุณูุญุงูู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุชููุงุฆูุงู
```

### ุงูุงุฎุชุจุงุฑ 3: ุงูุฅูุชุฑูุช ุงูุจุทูุก
```
1. ูุนูู ูุถุน 3G ุฃู ุฃุจุทุฃ
2. ุงุจุฏุฃ ุงูุชุดุบูู
3. โ ุณููุชุธุฑ 30 ุซุงููุฉ ุฃู ูุญุงูู ุงูุฅุนุงุฏุฉ
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **Timeout 30 ุซุงููุฉ**:
   - ูุงููุฉ ูููููุงุช ุงูุตูุชูุฉ ุงูุนุงุฏูุฉ
   - ุชููุน ุงูุงูุชุธุงุฑ ุงููุงููุงุฆู

2. **ูุญุงููุฉ ูุงุญุฏุฉ ููุท**:
   - ูุง ูุญุงูู ูุซูุฑุงู ูุชุฌูุจ ุงุณุชููุงู ุงูุจูุงูุงุช
   - ูุญุงููุฉ ูุงุญุฏุฉ ุนุงุฏุฉ ุชููู

3. **ุงูุฎุฏูุฉ ุงูุฎูููุฉ ุงุฎุชูุงุฑูุฉ**:
   - ุงูุชุดุบูู ุงููุญูู ุงูุฃุณุงุณู ูุง ูุนุชูุฏ ุนูููุง
   - ุฅุฐุง ูุดูุชุ ูุณุชูุฑ ุงูุชุดุบูู ุนุงุฏูุงู

4. **ุฑุณุงุฆู ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ**:
   - ุงููุณุชุฎุฏู ูููู ูุง ูุญุฏุซ
   - ูุง ุฑุณุงุฆู ุชูููุฉ ูุนูุฏุฉ

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

1. `lib/core/services/audio_player/audio_player_service.dart`
   - ุฅุถุงูุฉ retry mechanism
   - ูุนุงูุฌุฉ ุขููุฉ ููุฎุฏูุฉ ุงูุฎูููุฉ

2. `lib/features/quran_audio/presentation/bloc/quran_audio_cubit.dart`
   - ูุญุงููุฉ ูุชูุฏูุฉ ูู ุงูู Cubit
   - ุฑุณุงุฆู ุฎุทุฃ ูุญุณููุฉ

3. `lib/features/quran_audio/presentation/screens/audio_player_screen.dart`
   - ุนุฑุถ ุญุงูุฉ ุงูุชุญููู ุจูุถูุญ
   - UI ูุญุณูู ููุฃุฎุทุงุก

---

## ๐ ุงููุชูุฌุฉ

ุงูุขู ูุดุบู ุงูุตูุช:
- โ ููู ููุณุชูุฑ
- โ ูุนูุฏ ุงููุญุงููุฉ ุชููุงุฆูุงู
- โ ูุนุทู ุฑุณุงุฆู ูุงุถุญุฉ ูููุณุชุฎุฏู
- โ ูุนุงูุฌุฉ ุขููุฉ ูุฌููุน ุงูุฃุฎุทุงุก
- โ ูุง ูููุทุน ุนูุฏ ุงูุฃุฎุทุงุก ุงูุซุงูููุฉ

**ุงุณุชูุชุน ุจุงูุงุณุชูุงุน ุงูุขู! ๐ต**
