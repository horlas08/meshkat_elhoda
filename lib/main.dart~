import 'dart:developer';
import 'package:flutter/material.dart';
import 'package:awesome_notifications/awesome_notifications.dart'
    hide NotificationHandler;
import 'package:http/http.dart' as http;
import 'package:meshkat_elhoda/core/services/in_app_purchase_service.dart';
import 'package:meshkat_elhoda/core/network/network_info.dart';
import 'package:meshkat_elhoda/core/services/prayer_notification_service_new.dart';
import 'package:meshkat_elhoda/core/utils/app_colors.dart';
import 'package:meshkat_elhoda/features/assistant/data/datasources/assistant_local_data_source.dart';
import 'package:meshkat_elhoda/features/assistant/data/datasources/assistant_remote_data_source.dart';
import 'package:meshkat_elhoda/features/assistant/data/repositories/assistant_repository_impl.dart';
import 'package:meshkat_elhoda/features/assistant/domain/usecases/create_new_chat.dart';
import 'package:meshkat_elhoda/features/assistant/domain/usecases/get_chat_history.dart';
import 'package:meshkat_elhoda/features/assistant/domain/usecases/get_chat_list.dart';
import 'package:meshkat_elhoda/features/assistant/domain/usecases/send_message.dart';
import 'package:meshkat_elhoda/features/assistant/presentation/bloc/assistant_bloc.dart';
import 'package:meshkat_elhoda/features/auth/domain/usecases/reset_password.dart';
import 'package:meshkat_elhoda/features/azkar/presentation/bloc/azkar_bloc.dart';
import 'package:meshkat_elhoda/features/favorites/presentation/bloc/favorites_bloc.dart';
import 'package:meshkat_elhoda/features/hadith/presentation/bloc/hadith_bloc.dart';
import 'package:meshkat_elhoda/features/mosques/data/datasources/mosques_local_data_source.dart';
import 'package:meshkat_elhoda/features/mosques/data/datasources/mosques_remote_data_source.dart';
import 'package:meshkat_elhoda/features/mosques/data/repositories/mosque_repository_impl.dart';
import 'package:meshkat_elhoda/features/mosques/domain/usecases/get_nearby_mosques.dart';
import 'package:meshkat_elhoda/features/mosques/presentation/bloc/mosque_bloc.dart';
import 'package:meshkat_elhoda/features/quran_audio/presentation/bloc/quran_audio_cubit.dart';
import 'package:meshkat_elhoda/features/quran_index/presentation/widgets/loading_widget.dart';
import 'package:meshkat_elhoda/features/subscription/presentation/bloc/subscription_bloc.dart';
import 'package:meshkat_elhoda/features/settings/presentation/cubit/theme_cubit.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:meshkat_elhoda/core/utils/app_preferences.dart';
import 'package:meshkat_elhoda/features/auth/presentation/bloc/auth_state.dart';
import 'package:meshkat_elhoda/features/main_navigation/presentation/views/main_navigation_views.dart';
import 'package:meshkat_elhoda/l10n/app_localizations.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:meshkat_elhoda/core/network/firebase_service.dart';
import 'package:meshkat_elhoda/core/services/service_locator.dart';
import 'package:meshkat_elhoda/core/utils/size_utils.dart';
import 'package:meshkat_elhoda/features/auth/data/data_sources/auth_remote_data_source_impl.dart';
import 'package:meshkat_elhoda/features/auth/data/repositories/auth_repository_impl.dart';
import 'package:meshkat_elhoda/features/auth/domain/usecases/register_as_guest.dart';
import 'package:meshkat_elhoda/features/auth/domain/usecases/sign_in_with_email_and_password.dart';
import 'package:meshkat_elhoda/features/auth/domain/usecases/sign_up_with_email_and_password.dart';
import 'package:meshkat_elhoda/features/auth/presentation/bloc/auth_bloc.dart';
import 'package:meshkat_elhoda/features/auth/presentation/bloc/auth_event.dart';
import 'package:meshkat_elhoda/features/onboarding/presentation/screens/onboarding_screen.dart';
import 'package:meshkat_elhoda/firebase_options.dart';
import 'package:meshkat_elhoda/features/quran_index/presentation/bloc/quran_bloc.dart';
import 'package:meshkat_elhoda/features/location/data/data_sources/location_local_data_source.dart';
import 'package:meshkat_elhoda/features/location/data/data_sources/location_remote_data_source.dart';
import 'package:meshkat_elhoda/features/location/data/repositories/location_repository_impl.dart';
import 'package:meshkat_elhoda/features/location/domain/usecases/get_current_location.dart';
import 'package:meshkat_elhoda/features/location/domain/usecases/get_location_from_city_country.dart';
import 'package:meshkat_elhoda/features/location/domain/usecases/get_stored_location.dart';
import 'package:meshkat_elhoda/features/location/domain/usecases/request_location_permission.dart';
import 'package:meshkat_elhoda/features/location/domain/usecases/save_location.dart';
import 'package:meshkat_elhoda/features/location/presentation/bloc/location_bloc.dart';
import 'package:meshkat_elhoda/features/location/presentation/bloc/location_event.dart'; // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
import 'package:meshkat_elhoda/features/prayer_times/presentation/bloc/prayer_times_bloc.dart';
import 'package:meshkat_elhoda/core/services/admob_service.dart';
import 'package:meshkat_elhoda/core/services/location_refresh_service.dart';
import 'features/prayer_times/presentation/bloc/prayer_times_state.dart';
import 'package:audio_service/audio_service.dart';
import 'package:meshkat_elhoda/core/services/meshkat_audio_handler.dart';
import 'package:meshkat_elhoda/features/settings/data/models/notification_settings_model.dart';
import 'package:meshkat_elhoda/features/quran_khatmah/presentation/bloc/khatmah_bloc.dart';
import 'package:meshkat_elhoda/core/services/notification_handler.dart';
import 'package:meshkat_elhoda/core/services/collective_khatma_notification_service.dart';
import 'package:meshkat_elhoda/features/collective_khatma/presentation/bloc/collective_khatma_bloc.dart';
import 'package:meshkat_elhoda/core/services/athan_audio_service.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  AwesomeNotifications().setListeners(
    onActionReceivedMethod: NotificationHandler.onActionReceivedMethod,
    onNotificationCreatedMethod: NotificationHandler.onNotificationCreatedMethod,
    onNotificationDisplayedMethod: NotificationHandler.onNotificationDisplayedMethod,
    onDismissActionReceivedMethod: NotificationHandler.onDismissActionReceivedMethod,
  );

  try {
    await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
    await configureDependencies();

    try {
      await getIt<AdMobService>().initialize(useTestAds: false);
    } catch (e) { log('âš ï¸ AdMob Error: $e'); }

    final audioHandler = await AudioService.init(
      builder: () => MeshkatAudioHandler(),
      config: const AudioServiceConfig(
        androidNotificationChannelId: 'com.meshkatelhoda.pro.audio',
        androidNotificationChannelName: 'Meshkat Audio',
        androidNotificationOngoing: true,
        notificationColor: Color(0xFFD4AF37),
      ),
    );
    getIt.registerSingleton<AudioHandler>(audioHandler);

    await PrayerNotificationService().initialize();
    await NotificationHandler().initialize();
    await CollectiveKhatmaNotificationService().initialize();
    CollectiveKhatmaNotificationService().processBackgroundChecks();

    try {
      await getIt<InAppPurchaseService>().initialize();
    } catch (e) { log('âš ï¸ IAP Error: $e'); }

  } catch (e) { log('âŒ Init Error: $e'); }

  final sharedPreferences = await SharedPreferences.getInstance();
  runApp(MyApp(sharedPreferences: sharedPreferences));
}

class MyApp extends StatefulWidget {
  final SharedPreferences sharedPreferences;
  const MyApp({super.key, required this.sharedPreferences});

  @override
  State<MyApp> createState() => _MyAppState();
  static _MyAppState? of(BuildContext context) => context.findAncestorStateOfType<_MyAppState>();
}

class _MyAppState extends State<MyApp> {
  Locale? _locale;
  bool _hasPolicyChecksRun = false;
  final GlobalKey<NavigatorState> _navigatorKey = GlobalKey<NavigatorState>();

  @override
  void initState() {
    super.initState();
    _locale = _getLocaleFromDevice();
    _schedulePrayerNotificationsIfLocationExists();
  }

  // âœ… Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠØ§Ù„ÙˆØ¬ Ø§Ù„Ø¥ÙØµØ§Ø­ Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø±ÙØ¶ Ø¬ÙˆØ¬Ù„)
  void _showLocationDisclosureDialog() {
    final navContext = _navigatorKey.currentContext;
    if (navContext == null) return;

    final isRTL = _locale?.languageCode == 'ar';

    showDialog(
      context: navContext,
      barrierDismissible: false,
      builder: (dialogContext) => AlertDialog(
        title: Text(isRTL ? 'ğŸ“ ØªØ­Ø³ÙŠÙ† Ø¯Ù‚Ø© Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©' : 'ğŸ“ Location Precision'),
        content: Text(
          isRTL
              ? 'ÙŠØ­ØªØ§Ø¬ ØªØ·Ø¨ÙŠÙ‚ Ù…Ø´ÙƒØ§Ø© Ø§Ù„Ù‡Ø¯Ù‰ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø­ØªÙ‰ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù…ØºÙ„Ù‚Ø§Ù‹ØŒ ÙˆØ°Ù„Ùƒ Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ø°Ø§Ù† ÙˆØ§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.'
              : 'Mishkat Al-Hoda needs background location access to ensure accurate prayer times, Athan notifications, and Qibla direction based on your current location even when the app is closed.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(dialogContext),
            child: Text(isRTL ? 'Ù„Ø§Ø­Ù‚Ø§Ù‹' : 'Later'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(dialogContext);
              // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø­Ø¯Ø« Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ù€ Bloc
              _navigatorKey.currentContext?.read<LocationBloc>().add(RequestLocationPermissionEvent());
            },
            child: Text(isRTL ? 'Ù…ÙˆØ§ÙÙ‚' : 'Accept'),
          ),
        ],
      ),
    );
  }

  Future<void> _checkBatteryOptimization() async {
    try {
      final isBatteryOptimized = await AthanAudioService().isBatteryOptimized();
      final hasDeclinedBefore = widget.sharedPreferences.getBool('declined_battery_optimization') ?? false;

      if (isBatteryOptimized && !hasDeclinedBefore && mounted) {
        _showBatteryOptimizationDialog();
      }
    } catch (e) { log('âš ï¸ Battery check error: $e'); }
  }

  void _showBatteryOptimizationDialog() {
    final navContext = _navigatorKey.currentContext;
    if (navContext == null) return;
    final isRTL = _locale?.languageCode == 'ar';

    showDialog(
      context: navContext,
      builder: (dialogContext) => AlertDialog(
        title: Text(isRTL ? 'ğŸ”‹ ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' : 'ğŸ”‹ Optimize Performance'),
        content: Text(isRTL
            ? 'Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ø£Ø°Ø§Ù† ÙÙŠ Ù…ÙˆØ¹Ø¯Ù‡ØŒ ÙŠÙÙ†ØµØ­ Ø¨Ø¥Ø¹ÙØ§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©.'
            : 'To ensure timely Athan, please exempt the app from battery optimization.'),
        actions: [
          TextButton(
            onPressed: () async {
              await widget.sharedPreferences.setBool('declined_battery_optimization', true);
              Navigator.pop(dialogContext);
            },
            child: Text(isRTL ? 'Ù„Ø§Ø­Ù‚Ø§Ù‹' : 'Later'),
          ),
          ElevatedButton(
            onPressed: () async {
              Navigator.pop(dialogContext);
              await AthanAudioService().requestBatteryOptimizationExemption();
            },
            child: Text(isRTL ? 'Ø§Ù„Ø³Ù…Ø§Ø­' : 'Allow'),
          ),
        ],
      ),
    );
  }

  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ØºØ©ØŒ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...) ØªØ¸Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ
  Future<void> _schedulePrayerNotificationsIfLocationExists() async {
    final double? lat = widget.sharedPreferences.getDouble('latitude');
    final double? lng = widget.sharedPreferences.getDouble('longitude');
    if (lat != null && lng != null) {
      final settingsJson = widget.sharedPreferences.getString('NOTIFICATION_SETTINGS');
      final settings = settingsJson != null ? NotificationSettingsModel.fromJson(settingsJson) : const NotificationSettingsModel();
      await PrayerNotificationService().scheduleTodayPrayers(
          latitude: lat, longitude: lng,
          language: widget.sharedPreferences.getString('language') ?? 'ar',
          settings: settings
      );
    }
  }

  Locale _getLocaleFromDevice() {
    final deviceLocale = WidgetsBinding.instance.platformDispatcher.locale;
    const supported = ['ar', 'en', 'fr', 'id', 'ur', 'tr', 'bn', 'ms', 'fa', 'es', 'de', 'zh'];
    return supported.contains(deviceLocale.languageCode) ? deviceLocale : const Locale('en');
  }

  bool _isRTLLanguage(String? code) => ['ar', 'ur', 'fa'].contains(code);

  @override
  Widget build(BuildContext context) {
    return Sizer(
      builder: (context, orientation, deviceType) {
        return MultiBlocProvider(
          providers: [
            // ØªØ¸Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ Bloc Providers ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹
            BlocProvider<AuthBloc>(create: (context) {
              final authRepo = AuthRepositoryImpl(remoteDataSource: AuthRemoteDataSourceImpl(
                firebaseService: FirebaseService(auth: FirebaseAuth.instance, firestore: FirebaseFirestore.instance, storage: FirebaseStorage.instance),
                locationRemoteDataSource: LocationRemoteDataSourceImpl(),
              ));
              return AuthBloc(
                signInWithEmailAndPassword: SignInWithEmailAndPassword(authRepo),
                signUpWithEmailAndPassword: SignUpWithEmailAndPassword(authRepo),
                registerAsGuest: RegisterAsGuest(authRepo),
                resetPassword: ResetPassword(authRepo),
              )..add(AuthCheckRequested());
            }),
            BlocProvider<QuranBloc>(create: (context) => QuranBloc(getAllSurahs: getIt(), getSurahByNumber: getIt(), getJuzSurahs: getIt(), getAyahTafsir: getIt(), getReciters: getIt(), saveLastPosition: getIt(), getLastPosition: getIt(), getAudioUrl: getIt())),
            BlocProvider<LocationBloc>(create: (context) {
              final repo = LocationRepositoryImpl(remoteDataSource: LocationRemoteDataSourceImpl(), localDataSource: LocationLocalDataSourceImpl(sharedPreferences: widget.sharedPreferences));
              return LocationBloc(
                requestLocationPermission: RequestLocationPermission(repo),
                getCurrentLocation: GetCurrentLocation(repo),
                getLocationFromCityCountry: GetLocationFromCityCountry(repo),
                getStoredLocation: GetStoredLocation(repo),
                saveLocation: SaveLocation(repo),
                locationRefreshService: LocationRefreshService(widget.sharedPreferences),
              );
            }),
            BlocProvider<PrayerTimesBloc>(create: (context) => getIt<PrayerTimesBloc>()),
            BlocProvider<HadithBloc>(create: (context) => getIt<HadithBloc>()),
            BlocProvider<AzkarBloc>(create: (context) => getIt<AzkarBloc>()),
            BlocProvider<MosqueBloc>(create: (context) => MosqueBloc(getNearbyMosques: GetNearbyMosques(MosqueRepositoryImpl(remoteDataSource: MosquesRemoteDataSourceImpl(client: http.Client()), localDataSource: MosquesLocalDataSourceImpl(sharedPreferences: widget.sharedPreferences), networkInfo: getIt<NetworkInfo>())))),
            BlocProvider<AssistantBloc>(create: (context) => AssistantBloc(getChatHistory: GetChatHistory(AssistantRepositoryImpl(remoteDataSource: AssistantRemoteDataSourceImpl(client: http.Client()), localDataSource: AssistantLocalDataSourceImpl(sharedPreferences: widget.sharedPreferences), firestore: FirebaseFirestore.instance, auth: FirebaseAuth.instance)), createNewChat: CreateNewChat(getIt()), getChatList: GetChatList(getIt()), sendMessage: SendMessage(getIt()), localDataSource: getIt())),
            BlocProvider<QuranAudioBloc>(create: (context) => getIt<QuranAudioBloc>()),
            BlocProvider<FavoritesBloc>(create: (context) => getIt<FavoritesBloc>()),
            BlocProvider<SubscriptionBloc>(create: (context) => getIt<SubscriptionBloc>()),
            BlocProvider<ThemeCubit>(create: (context) => getIt<ThemeCubit>()..loadTheme()),
            BlocProvider<CollectiveKhatmaBloc>(create: (context) => getIt<CollectiveKhatmaBloc>()),
            BlocProvider<KhatmahBloc>(create: (context) => getIt<KhatmahBloc>()),
          ],
          child: BlocBuilder<ThemeCubit, ThemeMode>(
            builder: (context, themeMode) {
              final isRTL = _isRTLLanguage(_locale?.languageCode);
              return MaterialApp(
                navigatorKey: _navigatorKey,
                debugShowCheckedModeBanner: false,
                locale: _locale,
                localizationsDelegates: AppLocalizations.localizationsDelegates,
                supportedLocales: AppLocalizations.supportedLocales,
                builder: (context, child) {
                  // âœ… ØªØ´ØºÙŠÙ„ ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª (Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©) Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                  if (!_hasPolicyChecksRun) {
                    _hasPolicyChecksRun = true;
                    Future.delayed(const Duration(seconds: 3), () {
                      if (mounted) {
                        _showLocationDisclosureDialog(); // Ø£ÙˆÙ„Ø§Ù‹ Ø¥ÙØµØ§Ø­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                        _checkBatteryOptimization();     // Ø«Ø§Ù†ÙŠØ§Ù‹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
                      }
                    });
                  }
                  return Directionality(
                    textDirection: isRTL ? TextDirection.rtl : TextDirection.ltr,
                    child: child!,
                  );
                },
                themeMode: themeMode,
                theme: ThemeData(fontFamily: isRTL ? 'Tajawal' : 'Roboto', useMaterial3: true, colorSchemeSeed: AppColors.goldenColor),
                darkTheme: ThemeData(brightness: Brightness.dark, fontFamily: isRTL ? 'Tajawal' : 'Roboto', useMaterial3: true, scaffoldBackgroundColor: const Color(0xff0A2F45)),
                home: BlocBuilder<AuthBloc, AuthState>(
                  builder: (context, state) {
                    return FutureBuilder<bool>(
                      future: AppPreferences.isOnboardingCompleted(),
                      builder: (context, snapshot) {
                        if (state is Authenticated) return const MainNavigationViews();
                        return const OnboardingScreen();
                      },
                    );
                  },
                ),
              );
            },
          ),
        );
      },
    );
  }
}